name: Building Executables âš¡
run-name: ${{ github.actor }} is building TiPlot ğŸš€
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "package.json"

jobs:
  Build-AppImage:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code ğŸ“¥
        uses: actions/checkout@v3
      - name: Setup Python ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: List files ğŸ“„
        run: tree ğŸŒ³
      - name: Set variables ğŸ“
        run: |
          VER=$(grep -E -o '"version": ".*"' package.json | sed -e 's/"version": "//g' | tr -d '"')
          echo "VERSION=$VER" >> $GITHUB_ENV
      - name: Create Release ğŸ—ï¸
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.VERSION }}
          release_name: Tiplot v${{ env.VERSION }}
          body: ${{ github.event.head_commit.message }}
          draft: true
          prerelease: false
      - name: Restore virtualenv cache ğŸ“¦
        uses: syphar/restore-virtualenv@v1
        id: cache-virtualenv
        with:
          requirement_files: api/requirements.txt
      - name: Restore pip download cache ğŸ“¦
        uses: syphar/restore-pip-download-cache@v1
        if: steps.cache-virtualenv.outputs.cache-hit != 'true'
      - name: Install Python dependencies ğŸ
        run: pip install -r api/requirements.txt
        if: steps.cache-virtualenv.outputs.cache-hit != 'true'
      - name: Install Node dependencies ğŸ“¦
        run: yarn install
      - name: Build backend ğŸ”¨
        run: yarn build:api
      - name: Build desktop app ğŸ’»
        run: yarn build:electron
        env:
          GH_TOKEN: ${{ github.token }}
          # CI: false # ignore warnings

  Build-EXE:
    runs-on: windows-latest
    steps:
      - name: Checkout code ğŸ“¥
        uses: actions/checkout@v3
      - name: Setup Python ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: List files ğŸ“„
        run: tree ğŸŒ³
      - name: Install Node dependencies ğŸ“¦
        run: yarn install
      - name: Install Python dependencies ğŸ
        run: pip install -r api/requirements.txt
      - name: Build backend ğŸ”¨
        run: yarn build:api
      - name: Build desktop app ğŸ’»
        run: yarn build:electron
        env:
          GH_TOKEN: ${{ github.token }}
          # CI: false # ignore warnings
